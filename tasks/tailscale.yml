---

- name: install dependencies
  package:
    name: "{{ packages }}"
  vars:
    packages:
     - curl
     - jq

- name: create tailscale directories
  file:
    owner: root
    group: root
    path: "{{ item }}"
    state: directory
    mode: 0750
  with_items:
    - "/opt/tailscale"
    - "/opt/tailscale/bin"

- name: add tailscale dnf repository
  command: dnf config-manager --add-repo {{ tailscale_repository }}
  args:
    creates: /etc/yum.repos.d/tailscale.repo
    warn: false

- name: install tailscale
  dnf:
    name: tailscale
    state: present

- name: create directory for systemd drop-ins
  file:
    path: /etc/systemd/system/tailscaled.service.d
    owner: root
    group: root
    state: directory
    mode: 0755
  notify:
    - tailscale daemon-reload

- name: systemd drop-in for options
  template:
    src:  "drop-in-ferm.conf.j2"
    dest: "/etc/systemd/system/tailscaled.service.d/010-ferm.conf"
    owner: root
    group: root
    mode: 0644
  notify:
    - tailscale daemon-reload

- name: enable tailscaled on boot
  service: name=tailscaled enabled=yes

- name: create the tailscale ferm conf files
  template: src=templates/ferm-tailscale.conf.j2 dest=/etc/ferm/ferm.d/1020-tailscale.conf owner=root group=root mode=0600

- name: create the tailscale ferm var files
  template: src=templates/ferm-tailscale-variables.conf.j2 dest=/etc/ferm/vars.d/1010-tailscale.conf owner=root group=root mode=0600

- name: copy tailscale-up script
  ansible.builtin.copy:
    src: tailscale-up
    dest: /opt/tailscale/bin/tailscale-up
    mode: '0750'
    owner: root
    group: root

- name: copy run-tailscale script
  ansible.builtin.copy:
    src: run-tailscale
    dest: /opt/tailscale/bin/run-tailscale
    mode: '0750'
    owner: root
    group: root

# - name: check if kresd.conf.d exists
#   ansible.builtin.stat:
#     path: /etc/knot-resolver/kresd.conf.d/
#   register: tailscale_kresd_conf_d
#   changed_when: false
#
# - name: tailscale kresd configuration
#   template:
#     src: "kresd-view-tailscale.conf.j2"
#     dest: "/etc/knot-resolver/kresd.conf.d/910-view-tailscale.conf"
#     owner: root
#     group: knot-resolver
#     mode: 0640
#   when: tailscale_kresd_conf_d.stat.isdir is defined and tailscale_kresd_conf_d.stat.isdir
